{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Cadastrar Novo Trabalhador</h1>

    <form action="/inserir" method="POST">
        <h4>Dados Pessoais</h4>
        <div class="mb-3">
            <label for="nome" class="form-label">Nome completo</label>
            <input type="text" name="nome" id="nome" placeholder="Nome completo" required class="form-control">
        </div>
        <div class="mb-3">
            <label for="cpf" class="form-label">CPF</label>
            <input type="text" name="cpf" id="cpf" maxlength="14" placeholder="CPF" required class="form-control">
            <small id="cpfErro" class="text-danger" style="display: none;">CPF inv√°lido. Digite um CPF v√°lido com 11 n√∫meros.</small>
        </div>
        <div class="mb-3">
            <label for="celular" class="form-label">Celular</label>
            <input type="text" name="celular" id="celular" placeholder="Celular" class="form-control">
        </div>
        <div class="mb-3">
            <label for="profissao" class="form-label">Profiss√£o</label>
            <input type="text" name="profissao" id="profissao" placeholder="Profiss√£o" class="form-control">
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" name="email" id="email" placeholder="Email" required class="form-control">
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Senha</label>
            <div class="input-group">
                <input type="password" name="password" id="password" placeholder="Senha" required class="form-control">
                <button class="btn btn-outline-secondary" type="button" id="togglePassword"></button>
                <button class="btn btn-outline-secondary" type="button" id="generatePassword">Gerar Senha</button>
            </div>
            <small id="passwordStrength" class="text-muted">A senha deve conter letras mai√∫sculas e min√∫sculas, n√∫meros e caracteres especiais.</small>
        </div>
        <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirmar Senha</label>
            <div class="input-group">
                <input type="password" name="confirmPassword" id="confirmPassword" placeholder="Confirmar Senha" required class="form-control">
                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword"></button>
            </div>
            <small id="passwordMatchError" class="text-danger" style="display: none;">As senhas n√£o coincidem.</small>
        </div>
        <div class="mb-3">
            <label for="nascimento" class="form-label">Data de nascimento</label>
            <input type="date" name="nascimento" id="nascimento" placeholder="Data de nascimento" class="form-control">
        </div>

        <h4>Endere√ßo</h4>
        <div class="mb-3">
            <label for="cep" class="form-label">CEP</label>
            <input type="text" name="cep" id="cep" placeholder="CEP" class="form-control">
        </div>
        <div class="mb-3">
            <label for="rua" class="form-label">Rua</label>
            <input type="text" name="rua" id="rua" placeholder="Rua" class="form-control">
        </div>
        <div class="mb-3">
            <label for="numero" class="form-label">N√∫mero</label>
            <input type="text" name="numero" id="numero" placeholder="N√∫mero" class="form-control">
        </div>
        <div class="mb-3">
            <label for="complemento" class="form-label">Complemento</label> {# Novo campo Complemento #}
            <input type="text" name="complemento" id="complemento" placeholder="Ex: Apt 101, Bloco B" class="form-control">
        </div>
        <div class="mb-3">
            <label for="bairro" class="form-label">Bairro</label>
            <input type="text" name="bairro" id="bairro" placeholder="Bairro" class="form-control">
        </div>
        <div class="mb-3">
            <label for="cidade" class="form-label">Cidade</label>
            <input type="text" name="cidade" id="cidade" placeholder="Cidade" class="form-control">
        </div>
        <div class="mb-3">
            <label for="estado" class="form-label">Estado</label>
            <input type="text" name="estado" id="estado" placeholder="Estado" class="form-control">
        </div>

        <h4>Setores, Fun√ß√µes e Turnos</h4>
        <div id="vinculos">
            <div class="row g-3 align-items-end mb-3 vinculo">
                <div class="col">
                    <label for="setores[]" class="form-label">Setor:</label>
                    <select name="setores[]" class="form-select setor">
                        <option disabled selected>Selecione o setor</option>
                        {% for id, nome in setores %}
                            <option value="{{ id }}">{{ nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col">
                    <label for="funcoes[]" class="form-label">Fun√ß√£o:</label>
                    <select name="funcoes[]" class="form-select funcao">
                        <option disabled selected>Selecione o setor primeiro</option>
                    </select>
                </div>
                <div class="col">
                    <label for="dias_da_semana_raw[]" class="form-label">Dias da Semana:</label>
                    {# O select real, mas com um nome diferente para n√£o ser pego diretamente pelo Flask #}
                    <select name="dias_da_semana_raw[]" class="form-select dias-da-semana-select" multiple>
                        <option value="Segunda-feira">Segunda-feira</option>
                        <option value="Ter√ßa-feira">Ter√ßa-feira</option>
                        <option value="Quarta-feira">Quarta-feira</option>
                        <option value="Quinta-feira">Quinta-feira</option>
                        <option value="Sexta-feira">Sexta-feira</option>
                        <option value="S√°bado">S√°bado</option>
                        <option value="Domingo">Domingo</option>
                    </select>
                    {# Campo oculto que o Flask realmente ler√°, com os valores combinados #}
                    <input type="hidden" name="dias_da_semana[]" class="dias-da-semana-hidden-input">
                </div>
                <div class="col">
                    <label for="turnos[]" class="form-label">Turno:</label>
                    <select name="turnos[]" class="form-select">
                        <option disabled selected>Selecione o turno</option>
                        <option value="Manh√£">Manh√£</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                        <option value="N√£o se aplica">N√£o se aplica</option> {# Added option #}
                    </select>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-secondary mt-2" onclick="adicionarVinculo()">‚ûï Adicionar outro Setor</button>

        <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-success">Salvar</button>
        </div>
    </form>
</div>

<script>
function atualizarDiasDaSemanaHidden(vinculoDiv) {
    const selectDias = vinculoDiv.querySelector('.dias-da-semana-select');
    const hiddenInput = vinculoDiv.querySelector('.dias-da-semana-hidden-input');
    if (selectDias && hiddenInput) {
        const selectedOptions = Array.from(selectDias.selectedOptions).map(option => option.value);
        hiddenInput.value = selectedOptions.join(',');
    }
}

function aplicarEventosVinculo(vinculo) {
    const selectSetor = vinculo.querySelector('select[name="setores[]"]');
    const selectFuncao = vinculo.querySelector('select[name="funcoes[]"]');
    const selectDiasDaSemana = vinculo.querySelector('.dias-da-semana-select'); // Seleciona o select de dias

    if (selectSetor && selectFuncao) {
        selectSetor.addEventListener('change', function () {
            const setorId = this.value;
            fetch(`/api/funcoes_por_setor/${setorId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Fun√ß√µes recebidas:", data);
                    selectFuncao.innerHTML = '<option disabled selected>Selecione a fun√ß√£o</option>';
                    data.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.id;
                        opt.textContent = item.nome;
                        selectFuncao.appendChild(opt);
                    });
                })
                .catch(err => console.error("Erro ao buscar fun√ß√µes:", err));
        });
    }

    // Adiciona listener para o select de dias da semana
    if (selectDiasDaSemana) {
        selectDiasDaSemana.addEventListener('change', () => atualizarDiasDaSemanaHidden(vinculo));
        // Chama a fun√ß√£o uma vez para preencher o campo oculto no carregamento da p√°gina (se houver valores pr√©-selecionados)
        atualizarDiasDaSemanaHidden(vinculo);
    }


    const btnRemover = vinculo.querySelector('.remover-vinculo');
    if (btnRemover) {
        btnRemover.addEventListener('click', () => vinculo.remove());
    }
}

function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;

    let soma = 0;
    for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.charAt(9))) return false;

    soma = 0;
    for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.charAt(10))) return false;

    return true;
}

document.addEventListener('DOMContentLoaded', function () {

function aplicarMascaraCPF(campo) {
    campo.addEventListener('input', function () {
        let value = this.value.replace(/\D/g, '').slice(0, 11);
        if (value.length > 9)
            this.value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        else if (value.length > 6)
            this.value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, "$1.$2.$3");
        else if (value.length > 3)
            this.value = value.replace(/(\d{3})(\d{0,3})/, "$1.$2");
        else
            this.value = value;
    });
}

function aplicarMascaraCEP(campo) {
    campo.addEventListener('input', function () {
        let value = this.value.replace(/\D/g, '').slice(0, 8);
        if (value.length > 5)
            this.value = value.replace(/(\d{5})(\d{0,3})/, "$1-$2");
        else
            this.value = value;
    });
}

// Essas linhas devem estar FORA das fun√ß√µes acima:
const cpfInput = document.getElementById("cpf");
if (cpfInput) aplicarMascaraCPF(cpfInput);

const cepInput = document.getElementById("cep");
if (cepInput) aplicarMascaraCEP(cepInput);


    document.querySelectorAll('.vinculo').forEach(aplicarEventosVinculo);

    const form = document.querySelector("form");
    
    const cpfErro = document.getElementById("cpfErro");
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const togglePasswordButton = document.getElementById('togglePassword');
    const toggleConfirmPasswordButton = document.getElementById('toggleConfirmPassword');
    const generatePasswordButton = document.getElementById('generatePassword');
    const passwordMatchError = document.getElementById('passwordMatchError');
   


    // Valida√ß√£o de CPF antes do envio do formul√°rio
    if (form) {
        form.addEventListener("submit", function (e) {
            if (cpfInput && cpfErro) {
        const cpf = cpfInput.value.replace(/\D/g, ''); // <-- REMOVE a m√°scara
        if (!validarCPF(cpf)) {
            e.preventDefault();
            cpfErro.style.display = "block";
            cpfInput.classList.add('is-invalid');
            cpfInput.focus();
        } else {
            cpfErro.style.display = "none";
            cpfInput.classList.remove('is-invalid');
        }
    }

            // Valida√ß√£o de senhas coincidentes antes do envio do formul√°rio
            if (passwordInput && confirmPasswordInput && passwordMatchError) {
                if (passwordInput.value !== confirmPasswordInput.value) {
                    e.preventDefault();
                    passwordMatchError.style.display = 'block';
                    confirmPasswordInput.classList.add('is-invalid');
                    confirmPasswordInput.focus();
                } else {
                    passwordMatchError.style.display = 'none';
                    confirmPasswordInput.classList.remove('is-invalid');
                }
            }
        });
    }

    // Valida√ß√£o de CPF ao perder o foco (blur)
    if (cpfInput && cpfErro) {
        cpfInput.addEventListener('blur', function () {
    const cpf = this.value.replace(/\D/g, ''); // <-- REMOVE a m√°scara
    if (cpf.length > 0 && !validarCPF(cpf)) {
        cpfErro.style.display = 'block';
        this.classList.add('is-invalid');
    } else {
        cpfErro.style.display = 'none';
        this.classList.remove('is-invalid');
    }
});
    }

    // Preenchimento de CEP
    if (cepInput) {
        cepInput.addEventListener("blur", function () {
            const cep = this.value.replace(/\D/g, '');

            if (cep.length !== 8) {
                document.querySelector('input[name="rua"]').value = '';
                document.querySelector('input[name="numero"]').value = ''; // Adicionado para limpar o n√∫mero
                document.querySelector('input[name="complemento"]').value = ''; // Adicionado para limpar o complemento
                document.querySelector('input[name="bairro"]').value = '';
                document.querySelector('input[name="cidade"]').value = '';
                document.querySelector('input[name="estado"]').value = '';
                return;
            }

            const rua = document.querySelector('input[name="rua"]');
            const numero = document.querySelector('input[name="numero"]'); // Adicionado
            const complemento = document.querySelector('input[name="complemento"]'); // Adicionado
            const bairro = document.querySelector('input[name="bairro"]');
            const cidade = document.querySelector('input[name="cidade"]');
            const estado = document.querySelector('input[name="estado"]');

            rua.value = bairro.value = cidade.value = estado.value = "Carregando...";
            // Incluir complemento e n√∫mero na desativa√ß√£o
            rua.disabled = numero.disabled = complemento.disabled = bairro.disabled = cidade.disabled = estado.disabled = true;

            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (data.erro) {
                        rua.value = numero.value = complemento.value = bairro.value = cidade.value = estado.value = "";
                    } else {
                        rua.value = data.logradouro;
                        // O ViaCEP geralmente n√£o retorna n√∫mero ou complemento, ent√£o eles permanecem vazios ou como estavam
                        bairro.value = data.bairro;
                        cidade.value = data.localidade;
                        estado.value = data.uf;
                    }
                })
                .catch(() => {
                    // Tratar erro na busca do CEP
                })
                .finally(() => {
                    // Incluir complemento e n√∫mero na reativa√ß√£o
                    rua.disabled = numero.disabled = complemento.disabled = bairro.disabled = cidade.disabled = estado.disabled = false;
                });
        });
    }

    // Fun√ß√£o para alternar a visibilidade da senha
    function togglePasswordVisibility(input, button) {
        if (input.type === 'password') {
            input.type = 'text';
            button.innerHTML = 'üôà'; // √çcone de olho riscado (ocultar)
        } else {
            input.type = 'password';
            button.innerHTML = 'üëÅÔ∏è'; // √çcone de olho (mostrar)
        }
    }

    // Event Listeners para alternar visibilidade
    if (togglePasswordButton && passwordInput) {
        togglePasswordButton.addEventListener('click', () => togglePasswordVisibility(passwordInput, togglePasswordButton));
    }
    if (toggleConfirmPasswordButton && confirmPasswordInput) {
        toggleConfirmPasswordButton.addEventListener('click', () => togglePasswordVisibility(confirmPasswordInput, toggleConfirmPasswordButton));
    }

    // Event Listener para gerar senha forte
    if (generatePasswordButton && passwordInput && confirmPasswordInput) {
        generatePasswordButton.addEventListener('click', function () {
            const newPassword = generateStrongPassword(12);
            passwordInput.value = newPassword;
            confirmPasswordInput.value = newPassword; // Preenche o campo de confirma√ß√£o tamb√©m
            passwordInput.type = 'text'; // Mostra a senha gerada
            confirmPasswordInput.type = 'text';
            if (togglePasswordButton) togglePasswordButton.innerHTML = 'üôà';
            if (toggleConfirmPasswordButton) toggleConfirmPasswordButton.innerHTML = 'üôà';
            if (passwordMatchError) passwordMatchError.style.display = 'none'; // Esconde a mensagem de erro se houver
        });
    }

    // Valida√ß√£o de senhas coincidentes ao perder o foco
    if (passwordInput && confirmPasswordInput && passwordMatchError) {
        confirmPasswordInput.addEventListener('blur', function () {
            if (passwordInput.value !== this.value) {
                passwordMatchError.style.display = 'block';
                confirmPasswordInput.classList.add('is-invalid');
            } else {
                passwordMatchError.style.display = 'none';
                confirmPasswordInput.classList.remove('is-invalid');
            }
        });
        // Tamb√©m valida quando a senha principal muda
        passwordInput.addEventListener('blur', function() {
            if (confirmPasswordInput.value.length > 0 && passwordInput.value !== confirmPasswordInput.value) {
                passwordMatchError.style.display = 'block';
                confirmPasswordInput.classList.add('is-invalid');
            } else {
                passwordMatchError.style.display = 'none';
                confirmPasswordInput.classList.remove('is-invalid');
            }
        });
    }
});

function generateStrongPassword(length) {
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
    let password = "";

    const types = [
        "abcdefghijklmnopqrstuvwxyz",
        "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "0123456789",
        "!@#$%^&*()_+~`|}{[]:;?><,./-="
    ];

    for (let i = 0; i < types.length; i++) {
        password += getRandomChar(types[i]);
    }

    for (let i = types.length; i < length; i++) {
        password += getRandomChar(charset);
    }

    password = password.split('').sort(() => 0.5 - Math.random()).join('');

    return password;
}

function getRandomChar(charset) {
    return charset[Math.floor(Math.random() * charset.length)];
}

function adicionarVinculo() {
    const container = document.getElementById("vinculos");
    const div = document.createElement('div');
    div.className = 'row g-3 align-items-end mb-3 vinculo';

    div.innerHTML = `
        <div class="col">
            <label for="setores[]" class="form-label">Setor:</label>
            <select name="setores[]" class="form-select setor">
                <option disabled selected>Selecione o setor</option>
                {% for id, nome in setores %}
                    <option value="{{ id }}">{{ nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col">
            <label for="funcoes[]" class="form-label">Fun√ß√£o:</label>
            <select name="funcoes[]" class="form-select funcao">
                <option disabled selected>Selecione o setor primeiro</option>
            </select>
        </div>
        <div class="col">
            <label for="dias_da_semana_raw[]" class="form-label">Dias da Semana:</label>
            <select name="dias_da_semana_raw[]" class="form-select dias-da-semana-select" multiple>
                <option value="Segunda-feira">Segunda-feira</option>
                <option value="Ter√ßa-feira">Ter√ßa-feira</option>
                <option value="Quarta-feira">Quarta-feira</option>
                <option value="Quinta-feira">Quinta-feira</option>
                <option value="Sexta-feira">Sexta-feira</option>
                <option value="S√°bado">S√°bado</option>
                <option value="Domingo">Domingo</option>
            </select>
            <input type="hidden" name="dias_da_semana[]" class="dias-da-semana-hidden-input">
        </div>
        <div class="col">
            <label for="turnos[]" class="form-label">Turno:</label>
            <select name="turnos[]" class="form-select">
                <option value="Manh√£">Manh√£</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
                <option value="N√£o se aplica">N√£o se aplica</option> {# Added option #}
            </select>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-danger btn-sm remover-vinculo">X</button>
        </div>
    `;
    container.appendChild(div);
    aplicarEventosVinculo(div);
}
</script>
{% endblock %}
