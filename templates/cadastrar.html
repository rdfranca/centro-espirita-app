
{% extends "base.html" %}
{% block content %}
<h1>Cadastrar Novo Trabalhador</h1>
<form action="/inserir" method="POST" action="/inserir" method="POST">
    <h2>Dados Pessoais</h2>
    <input type="text" name="nome" placeholder="Nome completo" required>
    <div class="mb-3">
    <input type="text" name="cpf" id="cpf" maxlength="11" placeholder="CPF" required class="form-control">
    <small id="cpfErro" style="color: red; display: none;">CPF inválido. Digite um CPF válido com 11 números.</small>
    </div>
    <input type="text" name="celular" placeholder="Celular">
    <input type="text" name="profissao" placeholder="Profissão">
    <input type="date" name="nascimento" placeholder="Data de nascimento">

    <h2>Endereço</h2>
    <input type="text" name="cep" placeholder="CEP">
    <input type="text" name="rua" placeholder="Rua">
    <input type="text" name="numero" placeholder="Número">
    <input type="text" name="bairro" placeholder="Bairro">
    <input type="text" name="cidade" placeholder="Cidade">
    <input type="text" name="estado" placeholder="Estado">

    <h2>Setores, Funções e Turnos</h2>
    <div id="vinculos">
        <div class="vinculo" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <label for="setores[]">Setor:</label>
            <select name="setores[]">
                <option disabled selected>Selecione o setor</option>
                {% for id, nome in setores %}
                    <option value="{{ id }}">{{ nome }}</option>
                {% endfor %}
            </select>

            <label for="funcoes[]">Função:</label>
            <select name="funcoes[]">
                <option disabled selected>Selecione o setor primeiro</option>
            </select>

            <label for="turnos[]">Turno:</label>
            <select name="turnos[]">
                <option disabled selected>Selecione o turno</option>
                <option value="Manhã">Manhã</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
            </select>
        </div>
    </div>
    <button type="button" class="btn" onclick="adicionarVinculo()">Adicionar outro</button>
    <br><br>
    <button type="submit" class="btn">Salvar</button>
</form>

<script>
function aplicarEventosVinculo(vinculo) {
    const selectSetor = vinculo.querySelector('select[name="setores[]"]');
    const selectFuncao = vinculo.querySelector('select[name="funcoes[]"]');

    selectSetor.addEventListener('change', function () {
        const setorId = this.value;
        fetch(`/funcoes/${setorId}`)
            .then(response => response.json())
            .then(data => {
                console.log("Funções recebidas:", data);
                selectFuncao.innerHTML = '<option disabled selected>Selecione a função</option>';
                data.forEach(([id, nome]) => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = nome;
                    selectFuncao.appendChild(opt);
                });
            })
            .catch(err => console.error("Erro ao buscar funções:", err));
    });
}

function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

    function calcDigito(cpf, peso) {
        let soma = 0;
        for (let i = 0; i < peso.length; i++) {
            soma += parseInt(cpf[i]) * peso[i];
        }
        let resto = soma % 11;
        return resto < 2 ? 0 : 11 - resto;
    }

    const dig1 = calcDigito(cpf, [10,9,8,7,6,5,4,3,2]);
    const dig2 = calcDigito(cpf + dig1, [11,10,9,8,7,6,5,4,3,2]);

    return cpf[9] == dig1 && cpf[10] == dig2;
}

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.vinculo').forEach(aplicarEventosVinculo);

    // Validação de CPF antes do envio do formulário
    const form = document.querySelector("form");
    form.addEventListener("submit", function (e) {
        const cpfInput = document.getElementById("cpf");
        const erro = document.getElementById("cpfErro");
        const cpf = cpfInput.value;

        if (!validarCPF(cpf)) {
            e.preventDefault();
            erro.style.display = "block";
            cpfInput.focus();
        } else {
            erro.style.display = "none";
        }
    });
});

function adicionarVinculo() {
    const container = document.getElementById("vinculos");
    const div = document.querySelector(".vinculo").cloneNode(true);

    div.querySelector('select[name="setores[]"]').selectedIndex = 0;
    div.querySelector('select[name="funcoes[]"]').innerHTML = '<option disabled selected>Selecione o setor primeiro</option>';
    div.querySelector('select[name="turnos[]"]').selectedIndex = 0;

    aplicarEventosVinculo(div);
    container.appendChild(div);
}
</script>

{% endblock %}
