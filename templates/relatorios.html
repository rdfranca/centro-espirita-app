{% extends "base.html" %}
{% block content %}

    <h1 class="text-center mb-4">Relatório de Trabalhadores</h1>

    <div class="row mb-4 gx-4">
        <div class="col-md-4">
            <div class="mb-3">
                <label for="filtroSetor" class="form-label">Setor:</label>
                <select id="filtroSetor" class="form-select"></select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label for="filtroFuncao" class="form-label">Função:</label>
                <select id="filtroFuncao" class="form-select"></select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label for="filtroTurno" class="form-label">Turno:</label>
                <select id="filtroTurno" class="form-select">
                    <option value="">Todos</option>
                    <option value="Manhã">Manhã</option>
                    <option value="Tarde">Tarde</option>
                    <option value="Noite">Noite</option>
                </select>
            </div>
        </div>
    </div>

    <table id="tabelaRelatorio" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>Celular</th>
                <th>Profissão</th>
                <th>Nascimento</th>
                <th>CEP</th>
                <th>Rua</th>
                <th>Número</th>
                <th>Bairro</th>
                <th>Cidade</th>
                <th>Estado</th>
                <th>Setor</th>
                <th>Função</th>
                <th>Turno</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>

<script>
$(document).ready(function() {

    // 1. Função auxiliar para popular os selects
    function popularFiltro(url, selectId) {
        fetch(url)
            .then(res => res.json())
            .then(data => {
                const selectElement = $(selectId);
                selectElement.empty(); // Limpa as opções existentes
                selectElement.append('<option value="">Todos</option>'); // Adiciona a opção "Todos"

                data.forEach(item => {
                    // Aqui, use item.nome no value, pois é o que a coluna da tabela retorna (row[12] e row[13])
                    selectElement.append(`<option value="${item.nome}">${item.nome}</option>`);
                });
            })
            .catch(error => console.error(`Erro ao carregar ${selectId}:`, error));
    }

    // 2. Chama as novas rotas do backend para popular os filtros
    popularFiltro('/api/setores_para_filtro', '#filtroSetor');
    popularFiltro('/api/funcoes_para_filtro', '#filtroFuncao');

    // 3. Carrega os dados da tabela
    fetch('/api/relatorios')
        .then(res => res.json())
        .then(data => {
            const tabela = $('#tabelaRelatorio').DataTable({
                data: data,
                columns: [
                    { data: 'nome' },
                    { data: 'cpf' },
                    { data: 'celular' },
                    { data: 'profissao' },
                    { data: 'nascimento' },
                    { data: 'cep' },
                    { data: 'rua' },
                    { data: 'numero' },
                    { data: 'bairro' },
                    { data: 'cidade' },
                    { data: 'estado' },
                    { data: 'setor' },   // Coluna 11
                    { data: 'funcao' },  // Coluna 12
                    { data: 'turno' }    // Coluna 13
                ],
                dom: 'Bfrtip',
                buttons: [
                    'excelHtml5',
                    'pdfHtml5'
                ]
            });

            // Removida a lógica de preencher filtros a partir dos dados da tabela,
            // pois agora eles são populados diretamente do banco de dados.
            /*
            const setores = new Set();
            const funcoes = new Set();
            data.forEach(item => {
                setores.add(item.setor);
                funcoes.add(item.funcao);
            });
            setores.forEach(s => {
                $('#filtroSetor').append(`<option value="${s}">${s}</option>`);
            });
            funcoes.forEach(f => {
                $('#filtroFuncao').append(`<option value="${f}">${f}</option>`);
            });
            */

            // 4. Filtragem dinâmica (permanece a mesma, pois já funciona com os valores dos selects)
            $('#filtroSetor, #filtroFuncao, #filtroTurno').on('change', function () {
                const setor = $('#filtroSetor').val();
                const funcao = $('#filtroFuncao').val();
                const turno = $('#filtroTurno').val();

                tabela.columns(11).search(setor);
                tabela.columns(12).search(funcao);
                tabela.columns(13).search(turno);
                tabela.draw();
            });
        });
});
</script>
{% endblock %}