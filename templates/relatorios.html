{% extends "base.html" %}
{% block content %}

    <h1 class="text-center mb-4">Relatório de Trabalhadores</h1>

    <div class="row mb-4 gx-4">
        <div class="col-md-4">
            <div class="mb-3">
                <label for="filtroSetor" class="form-label">Setor:</label>
                <select id="filtroSetor" class="form-select"></select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label for="filtroFuncao" class="form-label">Função:</label>
                <select id="filtroFuncao" class="form-select"></select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label for="filtroTurno" class="form-label">Turno:</label>
                <select id="filtroTurno" class="form-select">
                    <option value="">Todos</option>
                    <option value="Manhã">Manhã</option>
                    <option value="Tarde">Tarde</option>
                    <option value="Noite">Noite</option>
                </select>
            </div>
        </div>
    </div>

    <table id="tabelaRelatorio" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>Celular</th>
                <th>Profissão</th>
                <th>Nascimento</th>
                <th>CEP</th>
                <th>Rua</th>
                <th>Número</th>
                <th>Bairro</th>
                <th>Cidade</th>
                <th>Estado</th>
                <th>Setor</th>
                <th>Função</th>
                <th>Turno</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>

<script>
$(document).ready(function() {

    let tabela; // Declarar a tabela fora do escopo do fetch para ser acessível globalmente no script

    // Função auxiliar para popular os selects
    function popularFiltro(url, selectId, valueProperty = 'nome', textProperty = 'nome') {
        fetch(url)
            .then(res => res.json())
            .then(data => {
                const selectElement = $(selectId);
                selectElement.empty(); // Limpa as opções existentes
                selectElement.append('<option value="">Todos</option>'); // Adiciona a opção "Todos"

                data.forEach(item => {
                    selectElement.append(`<option value="${item[valueProperty]}">${item[textProperty]}</option>`);
                });
            })
            .catch(error => console.error(`Erro ao carregar ${selectId}:`, error));
    }

    // Carregar Setores inicialmente (usando ID no value, nome no texto)
    // Agora o value será o ID do setor para poder buscar as funções por setor_id
    popularFiltro('/api/setores_para_filtro', '#filtroSetor', 'id', 'nome');

    // Carregar os dados da tabela
    fetch('/api/relatorios')
        .then(res => res.json())
        .then(data => {
            tabela = $('#tabelaRelatorio').DataTable({ // Atribuição à variável global
                data: data,
                columns: [
                    { data: 'nome' },
                    { data: 'cpf' },
                    { data: 'celular' },
                    { data: 'profissao' },
                    { data: 'nascimento' },
                    { data: 'cep' },
                    { data: 'rua' },
                    { data: 'numero' },
                    { data: 'bairro' },
                    { data: 'cidade' },
                    { data: 'estado' },
                    { data: 'setor' },   // Coluna 11
                    { data: 'funcao' },  // Coluna 12
                    { data: 'turno' }    // Coluna 13
                ],
                dom: 'Bfrtip',
                buttons: [
                    'excelHtml5',
                    'pdfHtml5'
                ]
            });
        });

    // === LÓGICA PARA CARREGAR FUNÇÕES BASEADO NO SETOR SELECIONADO ===
    $('#filtroSetor').on('change', function () {
        const setorId = $(this).val(); // Pega o ID do setor selecionado
        const filtroFuncao = $('#filtroFuncao');

        if (setorId) { // Se um setor foi selecionado (não é "Todos" ou vazio)
            // Chama a nova rota do backend com o ID do setor
            popularFiltro(`/api/funcoes_por_setor_para_filtro/${setorId}`, '#filtroFuncao', 'nome', 'nome'); // Agora 'nome' para value e text
        } else {
            // Se "Todos" os setores for selecionado, limpa o filtro de função
            filtroFuncao.empty();
            filtroFuncao.append('<option value="">Todos</option>');
        }
        // Dispara a filtragem da tabela após a mudança do setor (e possivelmente função)
        aplicarFiltrosTabela();
    });

    // === LÓGICA DE FILTRAGEM DINÂMICA DA TABELA ===
    // Centralizada em uma função para ser chamada em múltiplos lugares
    function aplicarFiltrosTabela() {
        if (!tabela) return; // Garante que a tabela foi inicializada

        // O valor do filtroSetor agora será o ID do setor no select.
        // Mas a coluna da tabela ainda tem o NOME do setor.
        // Precisamos traduzir o ID do setor para o nome do setor para filtrar a coluna 11.
        // Ou, alterar a rota /api/relatorios para retornar o ID do setor na coluna 11 também.
        // Por simplicidade, vamos pegar o TEXTO do select para filtrar.
        const setorNome = $('#filtroSetor option:selected').text();
        const funcaoNome = $('#filtroFuncao option:selected').text(); // Pega o texto, não o value (que pode ser ID)
        const turno = $('#filtroTurno').val();


        // A busca do DataTables funciona melhor com o TEXTO visível ou o valor exato da coluna.
        // Se a coluna 'setor' da tabela tem o NOME do setor, devemos filtrar pelo NOME.
        // Ajuste aqui para pegar o texto selecionado, se o value for o ID do banco.
        const setorParaFiltrar = (setorNome === "Todos" || setorNome === "Selecione o setor") ? "" : setorNome;
        const funcaoParaFiltrar = (funcaoNome === "Todos" || funcaoNome === "Selecione o setor primeiro" || funcaoNome === "Selecione a função") ? "" : funcaoNome;


        tabela.columns(11).search(setorParaFiltrar);
        tabela.columns(12).search(funcaoParaFiltrar);
        tabela.columns(13).search(turno); // Turno já está correto
        tabela.draw();
    }

    // Event listeners para os filtros
    $('#filtroFuncao, #filtroTurno').on('change', aplicarFiltrosTabela);

    // No carregamento inicial, aplicamos os filtros para garantir que a tabela seja carregada corretamente
    // e os filtros iniciais (Todos) sejam respeitados.
    aplicarFiltrosTabela(); // Chama no início, após a tabela ser carregada.

});
</script>
{% endblock %}