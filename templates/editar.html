{% extends "base.html" %}
{% block content %}
<h1>Editar Trabalhador</h1>
<form action="/atualizar/{{ trabalhador.id }}" method="POST">
    <h2>Dados Pessoais</h2>
    <input type="text" name="nome" value="{{ trabalhador.nome }}" placeholder="Nome completo" required>
    <input type="text" name="cpf" value="{{ trabalhador.cpf }}" placeholder="CPF" required>
    <input type="text" name="celular" value="{{ trabalhador.celular }}" placeholder="Celular">
    <input type="text" name="profissao" value="{{ trabalhador.profissao }}" placeholder="Profissão">
    <input type="date" name="nascimento" value="{{ trabalhador.nascimento }}" placeholder="Data de nascimento">

    <h2>Endereço</h2>
    <input type="text" name="cep" value="{{ trabalhador.cep }}" placeholder="CEP">
    <input type="text" name="rua" value="{{ trabalhador.rua }}" placeholder="Rua">
    <input type="text" name="numero" value="{{ trabalhador.numero }}" placeholder="Número">
    <input type="text" name="bairro" value="{{ trabalhador.bairro }}" placeholder="Bairro">
    <input type="text" name="cidade" value="{{ trabalhador.cidade }}" placeholder="Cidade">
    <input type="text" name="estado" value="{{ trabalhador.estado }}" placeholder="Estado">

    <h2>Setores, Funções e Turnos</h2>
    <div id="vinculos">
        {% for v in trabalhador.vinculos %}
        <div class="vinculo" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <label>Setor:</label>
            <select name="setores[]" disabled>
                {% for id, nome in setores %}
                    <option value="{{ id }}" {% if id == v.setor_id %}selected{% endif %}>{{ nome }}</option>
                {% endfor %}
            </select>

            <label>Função:</label>
            <select name="funcoes[]" disabled>
                {% for id, nome in funcoes_por_setor[v.setor_id] %}
                    <option value="{{ id }}" {% if id == v.funcao_id %}selected{% endif %}>{{ nome }}</option>
                {% endfor %}
            </select>

            <label>Turno:</label>
            <select name="turnos[]" disabled>
                <option value="Manhã" {% if v.turno == 'Manhã' %}selected{% endif %}>Manhã</option>
                <option value="Tarde" {% if v.turno == 'Tarde' %}selected{% endif %}>Tarde</option>
                <option value="Noite" {% if v.turno == 'Noite' %}selected{% endif %}>Noite</option>
            </select>

            <button type="button" class="btn btn-danger" onclick="removerVinculo(this)">❌</button>
        </div>
        {% endfor %}
    </div>
    <button type="button" class="btn" onclick="adicionarVinculo()">Adicionar outro Setor</button>

    <br><br>
    <button type="submit" class="btn">Salvar Alterações</button>
</form>

<script>
function removerVinculo(botao) {
    botao.parentElement.remove();
}

function adicionarVinculo() {
    const container = document.getElementById("vinculos");
    const div = document.createElement('div');
    div.classList.add('vinculo');
    div.style = "display: flex; gap: 10px; align-items: center; margin-bottom: 10px;";
    div.innerHTML = `
        <label>Setor:</label>
        <select name="setores[]">
            <option disabled selected>Selecione o setor</option>
            {% for id, nome in setores %}
                <option value="{{ id }}">{{ nome }}</option>
            {% endfor %}
        </select>

        <label>Função:</label>
        <select name="funcoes[]">
            <option disabled selected>Selecione o setor primeiro</option>
        </select>

        <label>Turno:</label>
        <select name="turnos[]">
            <option disabled selected>Selecione o turno</option>
            <option value="Manhã">Manhã</option>
            <option value="Tarde">Tarde</option>
            <option value="Noite">Noite</option>
        </select>

        <button type="button" class="btn btn-danger" onclick="removerVinculo(this)">❌</button>
    `;
    container.appendChild(div);
    aplicarEventosVinculo(div);
}

function aplicarEventosVinculo(vinculo) {
    const selectSetor = vinculo.querySelector('select[name="setores[]"]');
    const selectFuncao = vinculo.querySelector('select[name="funcoes[]"]');

    selectSetor.addEventListener('change', function () {
        const setorId = this.value;
        fetch(`/funcoes/${setorId}`)
            .then(response => response.json())
            .then(data => {
                selectFuncao.innerHTML = '<option disabled selected>Selecione a função</option>';
                data.forEach(([id, nome]) => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = nome;
                    selectFuncao.appendChild(opt);
                });
            })
            .catch(err => console.error("Erro ao buscar funções:", err));
    });
}
</script>
{% endblock %}
