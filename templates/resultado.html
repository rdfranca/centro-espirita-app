{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h1>Resultado da Busca</h1>
    {% if resultados %}
        {% for r in resultados %}
        <div class="card mb-4" id="trabalhador-{{ r.id }}">
            <div class="card-body">
                <h5 class="card-title">{{ r.nome or 'Nome N√£o Informado' }}</h5>
                <p class="card-text">
                    <strong>CPF:</strong> {{ r.cpf or '' }}<br>
                    <strong>Celular:</strong> {{ r.celular or '' }}<br>
                    <strong>Profiss√£o:</strong> {{ r.profissao or '' }}<br>
                    <strong>Nascimento:</strong> {{ r.nascimento or '' }}<br>
                    <strong>Endere√ßo:</strong> {{ r.rua or '' }}{% if r.numero %}, {{ r.numero }}{% endif %} - {{ r.bairro or '' }} - {{ r.cidade or '' }}/{{ r.estado or '' }}<br>
                </p>

                {% if r.vinculos %}
                <h6 class="card-subtitle mb-2 text-muted">V√≠nculos:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr class="table-light">
                                <th>Setor</th>
                                <th>Fun√ß√£o</th>
                                <th>Turno</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in r.vinculos %}
                            <tr>
                                <td>{{ v.setor }}</td>
                                <td>{{ v.funcao }}</td>
                                <td>{{ v.turno }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Nenhum v√≠nculo encontrado.</p>
                {% endif %}

                <!-- Bot√µes de a√ß√£o -->
                <div class="mt-3 d-flex justify-content-end">
                    <a href="{{ url_for('editar', trabalhador_id=r.id) }}" class="btn btn-warning me-2">‚úèÔ∏è Editar</a>
                    <button type="button" class="btn btn-danger" onclick="confirmarExclusao({{ r.id }}, '{{ r.nome | e }}')">üóëÔ∏è Excluir</button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="alert alert-info">Nenhum resultado encontrado.</p>
    {% endif %}
    <a href="/" class="btn btn-primary mt-4">Voltar</a>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o (Customizado) -->
<div class="modal fade" id="confirmarExclusaoModal" tabindex="-1" aria-labelledby="confirmarExclusaoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmarExclusaoModalLabel">Confirmar Exclus√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir o trabalhador <strong id="nomeTrabalhadorExcluir"></strong>? Esta a√ß√£o √© irrevers√≠vel.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">Excluir</button>
      </div>
    </div>
  </div>
</div>

<script>
// Vari√°vel global para armazenar o ID do trabalhador a ser exclu√≠do
let trabalhadorIdParaExcluir = null;

// Fun√ß√£o para exibir o modal de confirma√ß√£o
function confirmarExclusao(trabalhadorId, trabalhadorNome) {
    console.log("1. confirmarExclusao chamada com ID:", trabalhadorId, "Nome:", trabalhadorNome);
    trabalhadorIdParaExcluir = trabalhadorId;
    $('#nomeTrabalhadorExcluir').text(trabalhadorNome); // Atualiza o nome no modal
    
    // Verifica se bootstrap.Modal est√° dispon√≠vel
    if (typeof bootstrap === 'undefined' || typeof bootstrap.Modal === 'undefined') {
        console.error("Erro: Bootstrap JavaScript (bootstrap.bundle.min.js) n√£o foi carregado ou est√° em uma vers√£o incompat√≠vel.");
        // Fallback simples se o modal n√£o puder ser exibido
        if (window.confirm(`Tem certeza que deseja excluir ${trabalhadorNome}?`)) {
            executarExclusao();
        }
        return;
    }

    const myModal = new bootstrap.Modal(document.getElementById('confirmarExclusaoModal'));
    myModal.show();
    console.log("2. Modal de confirma√ß√£o exibido.");
}

// Fun√ß√£o para executar a exclus√£o (separada para ser chamada do modal ou fallback)
function executarExclusao() {
    if (trabalhadorIdParaExcluir !== null) {
        console.log("3. Bot√£o 'Excluir' do modal clicado ou fallback acionado. Enviando requisi√ß√£o para:", `/deletar/${trabalhadorIdParaExcluir}`);
        
        fetch(`/deletar/${trabalhadorIdParaExcluir}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log("4. Resposta da requisi√ß√£o recebida. Status:", response.status);
            if (!response.ok) {
                // Se a resposta n√£o for OK (ex: 404, 500), lan√ßa um erro para o .catch
                return response.json().then(err => { throw new Error(err.message || "Erro desconhecido no servidor."); });
            }
            return response.json();
        })
        .then(data => {
            console.log("5. Dados da resposta:", data);
            if (data.success) {
                console.log("6. Exclus√£o bem-sucedida no backend. Removendo elemento da interface.");
                const elementoTrabalhador = document.getElementById(`trabalhador-${trabalhadorIdParaExcluir}`);
                if (elementoTrabalhador) {
                    elementoTrabalhador.remove();
                    console.log("7. Elemento removido da DOM.");
                }
            } else {
                console.error("8. Erro reportado pelo backend:", data.message);
            }
        })
        .catch(error => {
            console.error("9. Erro na requisi√ß√£o de exclus√£o (rede ou servidor):", error);
        })
        .finally(() => {
            trabalhadorIdParaExcluir = null; // Limpa o ID ap√≥s a tentativa de exclus√£o
            console.log("10. Processo de exclus√£o finalizado.");
        });
    }
}

// Evento de clique no bot√£o "Excluir" dentro do modal
document.getElementById('btnConfirmarExclusao').addEventListener('click', executarExclusao);

// Verifica√ß√£o de carregamento do jQuery e Bootstrap no DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof jQuery === 'undefined') {
        console.error("Erro: jQuery n√£o est√° carregado. O Bootstrap e DataTables dependem dele.");
    }
    if (typeof bootstrap === 'undefined' || typeof bootstrap.Modal === 'undefined') {
        console.error("Erro: Bootstrap JavaScript (bootstrap.bundle.min.js) n√£o foi carregado ou est√° em uma vers√£o incompat√≠vel.");
    } else {
        console.log("Bootstrap JavaScript carregado com sucesso.");
    }
});
</script>
{% endblock %}
