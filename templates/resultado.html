{% extends "base.html" %}
{% block content %}
<div class="container mt-5"> {# Adicionado container e mt-5 para centralizar e dar espa√ßo #}
    <h1>Resultado da Busca</h1>
    {% if resultados %}
        {% for r in resultados %}
        <div class="card mb-4" id="trabalhador-{{ r.id }}"> {# Adicionado card e ID para f√°cil remo√ß√£o #}
            <div class="card-body">
                <h5 class="card-title">{{ r.nome or 'Nome N√£o Informado' }}</h5>
                <p class="card-text">
                    <strong>CPF:</strong> {{ r.cpf or '' }}<br>
                    <strong>Celular:</strong> {{ r.celular or '' }}<br>
                    <strong>Profiss√£o:</strong> {{ r.profissao or '' }}<br>
                    <strong>Nascimento:</strong> {{ r.nascimento or '' }}<br>
                    <strong>Endere√ßo:</strong> {{ r.rua or '' }}{% if r.numero %}, {{ r.numero }}{% endif %} - {{ r.bairro or '' }} - {{ r.cidade or '' }}/{{ r.estado or '' }}<br>
                </p>

                {% if r.vinculos %}
                <h6 class="card-subtitle mb-2 text-muted">V√≠nculos:</h6>
                <div class="table-responsive"> {# Adicionado para tabelas responsivas #}
                    <table class="table table-sm table-bordered"> {# Classes Bootstrap para tabela #}
                        <thead>
                            <tr class="table-light"> {# Cor de fundo para o cabe√ßalho #}
                                <th>Setor</th>
                                <th>Fun√ß√£o</th>
                                <th>Turno</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in r.vinculos %}
                            <tr>
                                <td>{{ v.setor }}</td>
                                <td>{{ v.funcao }}</td>
                                <td>{{ v.turno }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Nenhum v√≠nculo encontrado.</p>
                {% endif %}

                <!-- Bot√µes de a√ß√£o -->
                <div class="mt-3 d-flex justify-content-end"> {# Alinha os bot√µes √† direita #}
                    <a href="{{ url_for('editar', trabalhador_id=r.id) }}" class="btn btn-warning me-2">‚úèÔ∏è Editar</a>
                    <button type="button" class="btn btn-danger" onclick="confirmarExclusao({{ r.id }}, '{{ r.nome | e }}')">üóëÔ∏è Excluir</button>
                    {# Adicionado onclick para chamar a fun√ß√£o JS #}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="alert alert-info">Nenhum resultado encontrado.</p> {# Usando classe alert do Bootstrap #}
    {% endif %}
    <a href="/" class="btn btn-primary mt-4">Voltar</a> {# Usando classe btn-primary do Bootstrap #}
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o (Customizado) -->
<div class="modal fade" id="confirmarExclusaoModal" tabindex="-1" aria-labelledby="confirmarExclusaoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmarExclusaoModalLabel">Confirmar Exclus√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir o trabalhador <strong id="nomeTrabalhadorExcluir"></strong>? Esta a√ß√£o √© irrevers√≠vel.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">Excluir</button>
      </div>
    </div>
  </div>
</div>

<script>
// Vari√°vel global para armazenar o ID do trabalhador a ser exclu√≠do
let trabalhadorIdParaExcluir = null;

// Fun√ß√£o para exibir o modal de confirma√ß√£o
function confirmarExclusao(trabalhadorId, trabalhadorNome) {
    trabalhadorIdParaExcluir = trabalhadorId;
    $('#nomeTrabalhadorExcluir').text(trabalhadorNome); // Atualiza o nome no modal
    const myModal = new bootstrap.Modal(document.getElementById('confirmarExclusaoModal'));
    myModal.show();
}

// Evento de clique no bot√£o "Excluir" dentro do modal
document.getElementById('btnConfirmarExclusao').addEventListener('click', function() {
    if (trabalhadorIdParaExcluir !== null) {
        // Esconde o modal
        const myModal = bootstrap.Modal.getInstance(document.getElementById('confirmarExclusaoModal'));
        myModal.hide();

        // Envia a requisi√ß√£o DELETE para o backend
        fetch(`/deletar/${trabalhadorIdParaExcluir}`, {
            method: 'POST', // Usamos POST para simplicidade com formul√°rios HTML, mas DELETE seria mais RESTful se fosse uma API pura
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove o bloco do trabalhador da interface
                const elementoTrabalhador = document.getElementById(`trabalhador-${trabalhadorIdParaExcluir}`);
                if (elementoTrabalhador) {
                    elementoTrabalhador.remove();
                    // Opcional: exibir uma mensagem de sucesso tempor√°ria
                    // alert("Trabalhador exclu√≠do com sucesso!"); // Substituir por um toast/snackbar
                }
            } else {
                // Exibir mensagem de erro
                console.error("Erro ao excluir:", data.message);
                // alert("Erro ao excluir trabalhador: " + data.message); // Substituir por um toast/snackbar
            }
        })
        .catch(error => {
            console.error("Erro na requisi√ß√£o de exclus√£o:", error);
            // alert("Erro de rede ou servidor ao excluir trabalhador."); // Substituir por um toast/snackbar
        })
        .finally(() => {
            trabalhadorIdParaExcluir = null; // Limpa o ID ap√≥s a tentativa de exclus√£o
        });
    }
});
</script>
{% endblock %}
